version: 2.1

workflows:

  on-pull-request-update:
    jobs:
      - prepare:
          filters:
            branches:
              ignore: master
      - lint:
          requires:
            - prepare
          filters:
            branches:
              ignore: master
      - build:
          requires:
            - lint
          filters:
            branches:
              ignore: master

  on-master-merge:
    jobs:
      - publish:
          filters:
            branches:
              only: master


jobs:

  prepare:
    docker:
      # is there a benefit to defining it as an executor? maybe no more need for
      # clean pulls each time
      - image: 'funkyfisch/circleci-basic-linting:0.1'
    working_directory: ~/app
    steps:
      - checkout
      - run:
          name: Store list of modified files against master branch
          command: |
            git diff master.."$(git branch --show-current)" --name-only --diff-filter=d > changelist \
              && cat changelist
      - persist_to_workspace:
          root: .
          paths:
            - .

  lint:
    docker:
      - image: 'funkyfisch/circleci-basic-linting:0.1'
    working_directory: ~/app
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Run shellcheck on shell scripts, if any
          command: |
            if ! cat changelist | grep "\.\(sh\|ash\|bash\)"
            then
              echo "No shell scripts modified, skipping shellcheck"
            else
              shellcheck $(cat changelist | grep "\.\(sh\|ash\|bash\)")
            fi
      - run:
          name: Run hadolint on modified dockerfiles, if any
          command: |
            if ! cat changelist | grep "\(Dockerfile\|\.dockerfile\)"
            then
              echo "No dockerfiles modified, skipping hadolint"
            else
              echo "Running hadolint"
            fi

  build:
    machine: true
    working_directory: ~/app
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Build modified dockerfiles, if any
          command: |
            if ! cat changelist | grep "\(Dockerfile\|\.dockerfile\)"
            then
              echo "No dockerfiles modified, skipping build"
            else
              docker build \
                --build-arg NODE_MAJOR_VERSION=14 \
                --build-arg NPM_GLOBAL_MODULES="grunt gulp eslint nodemon" \
                -t node-docker-devenv:with-global-addons .
              docker build \
                --build-arg NODE_MAJOR_VERSION=12 \
                -t node-docker-devenv:12-no-global-addons .
            fi

  publish:
    docker:
      - image: cimg/base:2020.01
    steps:
      - run: echo "published!"
